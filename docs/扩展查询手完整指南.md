# 扩展查询手完整指南

## 📋 目录

- [功能概述](#功能概述)
- [使用指南](#使用指南)
- [技术实现](#技术实现)
- [测试指南](#测试指南)
- [常见问题](#常见问题)

---

## 🎉 功能概述

### 什么是扩展查询手？

扩展查询手是 LuxSelect 的智能功能，它能够根据用户的原始查询和 AI 的回答，自动推理出 3-5 个用户可能感兴趣的后续问题，并将这些问题动态添加到右键菜单中。

### 核心特性

- **智能推理**：AI 自动分析并生成相关问题
- **并行处理**：不阻塞主回答的显示
- **连续探索**：形成无限的知识探索链
- **即点即查**：点击问题立即获得详细回答

---

## 📖 使用指南

### 基本使用流程

#### 1. 触发查询

```
在任意应用中选中文本 → 等待 AI 回答 → 状态栏显示 "Done (右键查看更多)"
```

#### 2. 查看扩展问题

右键点击回答区域，看到：

```
1. [AI生成的扩展问题1]
2. [AI生成的扩展问题2]
3. [AI生成的扩展问题3]
─────────────────────
📄 复制全部内容
❌ 关闭
```

#### 3. 深入探索

点击感兴趣的问题 → 新回答替换旧内容 → 再次生成扩展问题 → 继续探索

### 使用场景示例

#### 场景 1：学习新技术

```
初始查询: Docker
     ↓
粗回答: Docker 容器技术简介
     ↓
扩展问题:
  1. Docker 与虚拟机有什么区别
  2. 如何编写 Dockerfile
  3. Docker Compose 的作用
     ↓
点击: "如何编写 Dockerfile"
     ↓
新回答: Dockerfile 编写详解
     ↓
新扩展问题:
  1. Dockerfile 最佳实践
  2. 多阶段构建是什么
  3. .dockerignore 的作用
```

#### 场景 2：历史探索

```
阿兰·图灵
  → 图灵测试是什么
    → 哪些 AI 通过了图灵测试
      → 现代 AI 评估方法
        → GPT 模型如何评估
```

#### 场景 3：科学概念

```
量子纠缠
  → 量子纠缠的应用
    → 量子通信原理
      → 量子密钥分发
        → 量子互联网的未来
```

### 使用技巧

#### 技巧 1：先浏览再选择
```
不要急于点击第一个问题，先浏览所有扩展问题，
选择最感兴趣或最相关的那一个。
```

#### 技巧 2：保存重要内容
```
点击新问题会清空当前内容，
记得在切换前复制重要信息（Ctrl+C）。
```

#### 技巧 3：构建知识地图
```
把探索路径记录下来：
Docker 
  → Dockerfile
    → 多阶段构建
      → 镜像优化
        → 最佳实践
```

#### 技巧 4：回到主题
```
如果探索得太深，想回到原始主题，
重新选中原始文本即可。
```

---

## 🛠️ 技术实现

### 架构设计

#### 1. 并行处理架构

```
用户选中文本
    |
    v
┌─────────────────────────┐
│  OverlayWindow.show_at() │
└─────────────────────────┘
    |
    v
┌─────────────────────────┐
│ start_ai_processing()    │ ← 启动主查询
└─────────────────────────┘
    |
    v
┌─────────────────────────┐
│ AIWorker (流式处理)      │
│ ├─ 文本解释...          │
│ ├─ 详细说明...          │
│ └─ 相关信息...          │
└─────────────────────────┘
    |
    v (完成后触发)
┌─────────────────────────┐
│ start_follow_up()        │ ← 启动扩展查询手
└─────────────────────────┘
    |
    v
┌─────────────────────────┐
│ FollowUpQuestionsWorker  │
│ (生成扩展问题)           │
└─────────────────────────┘
```

#### 2. Prompt 设计

扩展查询手使用专门的 prompt：

```python
system_prompt = """
你是一个智能问题推荐助手。根据用户选中的文本和已生成的解释，
推理出用户可能会进一步感兴趣的问题。

要求：
1. 生成 3-5 个相关的后续问题
2. 问题要具体、有针对性
3. 问题由浅入深，涵盖不同角度（历史、应用、原理、对比等）
4. 每个问题控制在 15 字以内
5. 返回 JSON 数组格式：["问题1", "问题2", "问题3"]
"""
```

### 代码实现

#### AI Client 层

```python
def generate_follow_up_questions(self, original_text: str, explanation: str) -> List[str]:
    """生成扩展问题"""
    # 1. 构建 prompt
    # 2. 调用 LLM API（非流式）
    # 3. 解析 JSON 响应
    # 4. 返回问题列表
```

#### Worker 层

```python
class FollowUpQuestionsWorker(QThread):
    """扩展查询手的异步处理线程"""
    questions_ready = pyqtSignal(list)
    
    def run(self):
        # 等待 500ms
        self.msleep(500)
        # 生成问题
        questions = self.client.generate_follow_up_questions(...)
        # 发送信号
        self.questions_ready.emit(questions)
```

#### UI 层

```python
def on_follow_up_question_clicked(self, question: str):
    """处理扩展问题点击"""
    # 清空当前显示
    self.content_area.clear()
    # 构建新查询
    full_question = f"关于「{self.original_query}」的问题：{question}"
    # 启动新查询
    self.start_ai_processing(full_question)
```

### 用户体验设计

#### 视觉反馈
- 状态栏提示："Done (右键查看更多)"
- 菜单标识：使用序号编号
- 缩进排版：区分层级

#### 容错设计
- 扩展查询手失败不影响主功能
- 所有错误都被捕获并记录日志
- 网络问题时优雅降级

---

## 🧪 测试指南

### 基础功能测试

#### 测试 1：自动生成扩展问题

**步骤**：
1. 选中文本："蒸汽机"
2. 等待回答完成
3. 观察状态栏变化

**预期结果**：
- 状态栏显示 "Done (右键查看更多)"
- 右键菜单显示 3-5 个扩展问题
- 问题与原始查询相关

#### 测试 2：点击扩展问题

**步骤**：
1. 右键点击第一个扩展问题

**预期结果**：
- 旧回答被清空
- 显示新回答
- 再次生成扩展问题

#### 测试 3：连续探索

**步骤**：
1. 选中 "人工智能"
2. 点击扩展问题："机器学习的原理"
3. 再次点击扩展问题："神经网络基础"
4. 继续点击 2-3 次

**目标**：形成完整的知识探索链

### 边界情况测试

#### 测试 4：网络错误

**步骤**：
1. 断开网络
2. 选中文本触发查询

**预期**：
- 主查询显示错误信息
- 扩展查询手静默失败
- 菜单中没有扩展问题，但其他功能正常

#### 测试 5：快速切换

**步骤**：
1. 选中文本 "量子力学"
2. 不等待完成，立即选中 "相对论"

**预期**：
- 旧窗口关闭
- 新窗口显示
- 扩展查询手正确处理取消

### 性能测试

**指标**：
- 主查询响应时间：< 1 秒
- 扩展问题生成时间：2-5 秒
- 菜单响应时间：< 100ms

---

## ❓ 常见问题

### Q1：扩展问题没有显示？

**可能原因**：
1. API 调用失败
2. 网络问题
3. LLM 返回格式不正确

**解决方法**：
```bash
# 查看日志
type %USERPROFILE%\.luxselect\logs\luxselect.log

# 搜索错误信息
grep "Follow-up" luxselect.log
grep "Error" luxselect.log
```

### Q2：扩展问题质量差？

**可能原因**：
1. 粗回答内容太少
2. Prompt 需要优化
3. 模型能力不足

**解决方法**：
- 增加粗回答的字数限制（AI_MAX_TOKENS）
- 使用更强大的模型（如 GPT-4）

### Q3：点击扩展问题后没反应？

**检查**：
- 确保网络连接正常
- 查看日志是否有错误信息
- 确认 API Key 配置正确

### Q4：如何禁用扩展查询手？

**目前不支持禁用，但可以选择不使用**：
- 不右键查看扩展问题即可
- 扩展查询手不会影响主功能

---

## 🎓 最佳实践

### 1. 耐心等待
看到 "Done (右键查看更多)" 提示后再右键查看

### 2. 选择性探索
不是所有问题都需要点击，选择最感兴趣的

### 3. 保存重要内容
在切换到新问题前，记得复制当前回答（Ctrl+C）

### 4. 连续探索
利用扩展问题形成知识网络，深度学习

---

## 🚀 未来展望

### 即将推出

1. **问题历史记录**
   - 记录所有查询过的问题
   - 支持快速回溯

2. **知识图谱可视化**
   - 可视化展示探索路径
   - 点击节点快速跳转

3. **个性化推荐**
   - 根据用户兴趣调整推荐
   - 学习用户偏好

4. **分享探索路径**
   - 导出为 Markdown
   - 分享给其他人

---

## 📞 反馈与支持

如有问题或建议：
- 📖 查看文档：`README.md`
- 🐛 报告问题：[GitHub Issues](https://github.com/loong-solvable/luxselect/issues)
- 💬 讨论交流：[GitHub Discussions](https://github.com/loong-solvable/luxselect/discussions)

---

**开始你的知识探索之旅！** 🚀

